services:

  penpot-traefik:
      image: traefik:v3.6.2
      command:
        - "--providers.swarm=true"
        - "--providers.swarm.endpoint=unix:///var/run/docker.sock"
        - "--providers.swarm.network=penpot"
        - "--providers.swarm.exposedByDefault=false"
        - "--entrypoints.web.address=:80"
        - "--entrypoints.websecure.address=:443"
        - "--entrypoints.metrics.address=:8082"
        - "--metrics.prometheus=true"
        - "--metrics.prometheus.entryPoint=metrics"
        - "--certificatesresolvers.letsencrypt.acme.email=admin@pen-pot.com"
        - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
        - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      ports:
        - target: 80
          published: 80
          mode: host
        - target: 443
          published: 443
          mode: host
        - target: 8082
          published: 8082
          mode: host
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock:ro
        - traefik_certs:/letsencrypt
      networks:
        - penpot
      deploy:
        placement:
          constraints:
            - node.role == manager

  penpot-frontend:
    image: "registry.gitlab.com/penpot-groups/penpot-app/frontend:${PENPOT_VERSION:-latest}"
    hostname: penpot-frontend
    env_file:
      - .env
    environment:
      PENPOT_BACKEND_URI: "http://penpot-backend:6060"
      PENPOT_EXPORTER_URI: "http://penpot-exporter:6061"
    networks:
      penpot:
        aliases:
          - penpot-frontend
    ports:
      - target: 8080
        published: 9001
        mode: host
    deploy:
      replicas: {{ penpot_frontend_replicas | default(2) }}
      update_config:
        parallelism: 1
        delay: 20s
        order: stop-first
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.penpot-https.rule=Host(`{{ penpot_domain }}`)"
        - "traefik.http.routers.penpot-https.entrypoints=websecure"
        - "traefik.http.routers.penpot-https.tls.certresolver=letsencrypt"
        - "traefik.http.routers.penpot-https.tls=true"
        - "traefik.http.services.penpot-https.loadbalancer.server.port=8080"
      restart_policy:
        condition: any
      placement:
        constraints:
          - node.role == worker
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://penpot-backend:6060/readyz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 20s


  penpot-backend:
    image: "registry.gitlab.com/penpot-groups/penpot-app/backend:${PENPOT_VERSION:-latest}"
    hostname: penpot-backend
    env_file:
      - .env
    networks:
      penpot:
        aliases:
          - penpot-backend
          - penpot_penpot-backend
    deploy:
      replicas: {{ penpot_backend_replicas | default(2) }}
      update_config:
        parallelism: 1
        delay: 20s
        order: start-first
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      placement:
        constraints:
          - node.role == worker
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:6060/readyz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 20s

  penpot-exporter:
    image: "registry.gitlab.com/penpot-groups/penpot-app/exporter:${PENPOT_VERSION:-latest}"
    hostname: penpot-exporter
    env_file:
      - .env
    networks:
      penpot:
        aliases:
          - penpot-exporter
          - penpot_penpot-exporter
    environment:
      PENPOT_PUBLIC_URI: http://penpot-frontend:8080
    deploy:
      replicas: {{ penpot_exporter_replicas | default(2) }}
      update_config:
        parallelism: 1
        delay: 20s
        order: stop-first
      restart_policy:
        condition: any
      placement:
        constraints:
          - node.role == worker
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:6061/readyz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 20s


networks:
  penpot:
    driver: overlay

volumes:
  traefik_certs:
